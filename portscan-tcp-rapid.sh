#!/bin/sh
set -eu

usage() {
  echo "Usage: ${0##*/} -T<0-5> <target-hosts-list.txt> <exclude-hosts-list.txt>"
}

if [ "$#" -eq 0 ]; then
  echo "Error: Target hosts must be specified"
  usage
  exit 1
fi

if [ "$1" = "-h" ]; then
  usage
  exit 0
fi

today=`date +%Y%m%d`
if [ ! -d ./results/${today} ]; then
  mkdir -p ./results/${today}
fi

threads=$1
hosts=`cat $2`
echo "Target: ${hosts}"

if [ "$#" -eq 3 ]; then
  exclude_hosts=$(<$3)
  for h in $hosts
  do
    host_name=`echo $h | tr "/" "_"`
    # With the T4 option, all ports are often filtered...
    # If SYN Scan(-sS) doesn't work, try TCP Connect Scan(-sT).
    now=`date +%Y%m%d_%H%M%S`
    # SYN Scan
    echo "Now Launching: sudo nmap --exclude ${exclude_hosts} -v -n -PS22,80,443 -sS --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h}"
    sudo nmap ${threads} --exclude ${exclude_hosts} -v -n -PS22,80,443 -sS --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h} -oN ./results/${today}/${host_name}_ping_${now}.txt
    # ------------------------
    # TCP Connect Scan
    # echo "Now Launching: sudo nmap --exclude ${exclude_hosts} -v -n -sT --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h}"
    # sudo nmap --exclude ${exclude_hosts} -v -n -sT --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h} -oN ./results/${today}/${host_name}_ping_${now}.txt
    # ------------------------
    # TCP Connect Scan, Host discovery disabled
    # echo "Now Launching: nmap --exclude ${exclude_hosts} -v -n -Pn -sT --host-timeout 30m -oX ./results/${today}/${host_name}_noping_${now}.xml ${h}"
    # sudo nmap --exclude ${exclude_hosts} -v -n -Pn -sT --host-timeout 30m -oX ./results/${today}/${host_name}_noping_${now}.xml ${h} -oN ./results/${today}/${host_name}_noping_${now}.txt
  done
fi

if [ "$#" -eq 2 ]; then
  for h in $hosts
  do
    host_name=`echo $h | tr "/" "_"`
    # With the T4 option, all ports are often filtered...
    # If SYN Scan(-sS) doesn't work, try TCP Connect Scan(-sT).
    now=`date +%Y%m%d_%H%M%S`
    # SYN Scan
    echo "Now Launching: sudo nmap -v -n -PS22,80,443 -sS --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h}"
    sudo nmap ${threads} -v -n -PS22,80,443 -sS --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h} -oN ./results/${today}/${host_name}_ping_${now}.txt
    # ------------------------
    # TCP Connect Scan
    # echo "Now Launching: sudo nmap -v -n -PS22,80,443 -sT --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h}"
    # sudo nmap -v -n -PS22,80,443 -sT --host-timeout 30m -oX ./results/${today}/${host_name}_ping_${now}.xml ${h} -oN ./results/${today}/${host_name}_ping_${now}.txt
    # ------------------------
    # TCP Connect Scan, Host discovery disabled
    # echo "Now Launching: nmap -v -n -Pn -sT --host-timeout 30m -oX ./results/${today}/${host_name}_noping_${now}.xml ${h}"
    # sudo nmap -v -n -Pn -sT --host-timeout 30m -oX ./results/${today}/${host_name}_noping_${now}.xml ${h} -oN ./results/${today}/${host_name}_noping_${now}.txt
  done
fi